<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Depunere - Casino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Depunere</h1>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>

    <div id="userSold" class="mb-3">
        <strong>Sold curent:</strong> <span>Încărcare...</span>
    </div>

    <div class="mb-3">
        <label for="sumaDepusa" class="form-label">Suma de depus:</label>
        <input type="number" id="sumaDepusa" class="form-control" min="1" step="0.01" />
    </div>

    <button id="depuneBtn" class="btn btn-primary">Depune</button>

    <div id="mesaj" class="mt-3"></div>

    <a href="profile.html" class="btn btn-link mt-4">Profil și tranzacții</a>
    <a href="index.html" class="btn btn-link mt-4">Înapoi la jocuri</a>
</div>

<script>
const API_URL = 'https://localhost:7201/api/casino';
const token = localStorage.getItem('token');

if (!token) {
    alert('Trebuie să te autentifici mai întâi!');
    window.location.href = 'login.html';
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = 'login.html';
});

const soldSpan = document.querySelector('#userSold span');
const mesajDiv = document.getElementById('mesaj');
const sumaInput = document.getElementById('sumaDepusa');
const depuneBtn = document.getElementById('depuneBtn');

async function incarcaSold() {
    try {
        const res = await fetch(`${API_URL}/tranzactii`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
            localStorage.removeItem('token');
            alert('Sesiunea a expirat. Te rugăm să te autentifici din nou.');
            window.location.href = 'login.html';
            return;
        }

        if (!res.ok) throw new Error('Nu am putut încărca soldul.');

        const tranzactii = await res.json();
        if (tranzactii.length === 0) {
            soldSpan.textContent = '0.00';
            return;
        }
        soldSpan.textContent = tranzactii[0].soldDupa.toFixed(2);
    } catch (err) {
        soldSpan.textContent = 'Eroare';
        console.error(err);
    }
}

depuneBtn.addEventListener('click', async () => {
    mesajDiv.textContent = '';
    mesajDiv.className = '';

    const suma = parseFloat(sumaInput.value);
    if (isNaN(suma) || suma <= 0) {
        mesajDiv.textContent = 'Introdu o sumă validă mai mare decât 0.';
        mesajDiv.className = 'text-danger';
        return;
    }

    try {
        const res = await fetch(`${API_URL}/depunere`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(suma)
        });

        if (res.status === 401) {
            localStorage.removeItem('token');
            alert('Sesiunea a expirat. Te rugăm să te autentifici din nou.');
            window.location.href = 'login.html';
            return;
        }

        const data = await res.json();

        if (!res.ok) {
            mesajDiv.textContent = data.message || 'Eroare la depunere.';
            mesajDiv.className = 'text-danger';
            return;
        }

        mesajDiv.textContent = `Depunere reușită! Sold curent: $${data.soldCurent.toFixed(2)}`;
        mesajDiv.className = 'text-success';
        soldSpan.textContent = data.soldCurent.toFixed(2);
        sumaInput.value = '';
    } catch (err) {
        mesajDiv.textContent = 'Eroare la comunicarea cu serverul.';
        mesajDiv.className = 'text-danger';
        console.error(err);
    }
});

incarcaSold();
</script>
</body>
</html>
