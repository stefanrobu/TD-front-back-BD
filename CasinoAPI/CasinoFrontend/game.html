<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Joacă - Casino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-4">
    <h1>Joacă</h1>
    <div id="userInfo" class="mb-3">
        <strong>Sold curent:</strong> <span id="sold">Încărcare...</span>
    </div>

    <div class="mb-3">
        <label for="sumaPariata" class="form-label">Suma pariată:</label>
        <input type="number" id="sumaPariata" class="form-control" min="1" step="0.01" />
    </div>

    <button id="joacaBtn" class="btn btn-primary">Joacă</button>

    <div id="rezultat" class="mt-3"></div>
    <div id="eroare" class="mt-3 text-danger"></div>

    <a href="index.html" class="btn btn-link mt-4">Înapoi la jocuri</a>
</div>

<script>
const API_URL = 'https://localhost:7201/api/casino';  // adaptează după backend

const soldSpan = document.getElementById('sold');
const joacaBtn = document.getElementById('joacaBtn');
const rezultatDiv = document.getElementById('rezultat');
const eroareDiv = document.getElementById('eroare');
const sumaInput = document.getElementById('sumaPariata');

let token = localStorage.getItem('token');
if (!token) {
    // Nu e logat → redirect la login
    alert('Trebuie să te autentifici mai întâi!');
    window.location.href = 'login.html';
}

// Funcție să încarce soldul curent din tranzacții
async function incarcaSold() {
    try {
        const res = await fetch(`${API_URL}/tranzactii`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
            // Token invalid sau expirat, redirect la login
            localStorage.removeItem('token');
            alert('Sesiunea a expirat. Te rugăm să te autentifici din nou.');
            window.location.href = 'login.html';
            return;
        }

        if (!res.ok) throw new Error('Nu am putut încărca soldul.');

        const tranzactii = await res.json();
        if (tranzactii.length === 0) {
            soldSpan.textContent = '0.00';
            return;
        }
        // Ultima tranzacție este prima în listă (ordine descrescătoare)
        soldSpan.textContent = parseFloat(tranzactii[0].soldDupa).toFixed(2);
    } catch (err) {
        soldSpan.textContent = 'Eroare';
        console.error(err);
    }
}

// Funcție pentru a juca
joacaBtn.addEventListener('click', async () => {
    eroareDiv.textContent = '';
    rezultatDiv.textContent = '';

    let suma = parseFloat(sumaInput.value);
    if (isNaN(suma) || suma <= 0) {
        eroareDiv.textContent = 'Introdu o sumă validă mai mare decât 0.';
        return;
    }

    try {
        const res = await fetch(`${API_URL}/play`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ sumaPariata: suma }) // obiect JSON, nu doar suma simplă
        });

        if (res.status === 401) {
            localStorage.removeItem('token');
            alert('Sesiunea a expirat. Te rugăm să te autentifici din nou.');
            window.location.href = 'login.html';
            return;
        }

        const data = await res.json();

        if (!res.ok) {
            eroareDiv.textContent = data.message || 'Eroare la joc.';
            return;
        }

        rezultatDiv.innerHTML = `
            <div class="alert ${data.rezultat.toLowerCase().includes('câștigat') ? 'alert-success' : 'alert-danger'}">
                ${data.rezultat}<br/>
                Câștig: $${data.castig.toFixed(2)}<br/>
                Sold curent: $${data.soldCurent.toFixed(2)}
            </div>
        `;

        soldSpan.textContent = data.soldCurent.toFixed(2);
    } catch (err) {
        eroareDiv.textContent = 'Eroare la comunicarea cu serverul.';
        console.error(err);
    }
});

// Încarcă soldul la pornire
incarcaSold();
</script>
</body>
</html>
